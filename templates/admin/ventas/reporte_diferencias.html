{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Reporte de Diferencias por Redondeo{% endblock %}

{% block content %}
<div style="padding: 20px;">
    <h1>üìä Reporte de Diferencias por Redondeo</h1>
    
    <!-- Selector de Per√≠odo -->
    <div style="background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <form method="get" style="display: flex; gap: 15px; align-items: center;">
            <label for="mes" style="font-weight: bold;">Mes:</label>
            <select name="mes" id="mes" style="padding: 5px;">
                {% for m in "123456789101112"|make_list %}
                    <option value="{{ forloop.counter }}" {% if forloop.counter == mes %}selected{% endif %}>
                        {{ forloop.counter|stringformat:"02d" }}
                    </option>
                {% endfor %}
            </select>
            
            <label for="a√±o" style="font-weight: bold;">A√±o:</label>
            <select name="a√±o" id="a√±o" style="padding: 5px;">
                {% for a in "2024,2025,2026"|split:"," %}
                    <option value="{{ a }}" {% if a|add:"0" == a√±o %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
            
            <button type="submit" style="padding: 8px 20px; background: #417690; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Generar Reporte
            </button>
        </form>
    </div>
    
    <!-- Resumen -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
        <div style="background: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 4px solid #417690;">
            <h3 style="margin: 0 0 10px 0; color: #417690;">Total Facturas</h3>
            <p style="font-size: 2em; font-weight: bold; margin: 0;">{{ total_facturas }}</p>
        </div>
        
        <div style="background: {% if facturas_con_diferencia > 0 %}#fff3cd{% else %}#d4edda{% endif %}; padding: 20px; border-radius: 8px; border-left: 4px solid {% if facturas_con_diferencia > 0 %}#ffc107{% else %}#28a745{% endif %};">
            <h3 style="margin: 0 0 10px 0; color: {% if facturas_con_diferencia > 0 %}#856404{% else %}#155724{% endif %};">Con Diferencia</h3>
            <p style="font-size: 2em; font-weight: bold; margin: 0;">{{ facturas_con_diferencia }}</p>
        </div>
        
        <div style="background: {% if total_diferencias < 0 %}#f8d7da{% elif total_diferencias > 0 %}#d1ecf1{% else %}#d4edda{% endif %}; padding: 20px; border-radius: 8px; border-left: 4px solid {% if total_diferencias < 0 %}#dc3545{% elif total_diferencias > 0 %}#17a2b8{% else %}#28a745{% endif %};">
            <h3 style="margin: 0 0 10px 0;">Diferencia Neta</h3>
            <p style="font-size: 2em; font-weight: bold; margin: 0;">
                {% if total_diferencias > 0 %}+{% endif %}${{ total_diferencias|floatformat:2 }}
            </p>
        </div>
    </div>
    
    <!-- Tabla de Detalles -->
    {% if detalles_list %}
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>Facturas con Diferencias</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 12px; text-align: left;">Folio</th>
                    <th style="padding: 12px; text-align: left;">Cliente</th>
                    <th style="padding: 12px; text-align: right;">Total Facturado</th>
                    <th style="padding: 12px; text-align: right;">Suma Productos</th>
                    <th style="padding: 12px; text-align: right;">Diferencia</th>
                </tr>
            </thead>
            <tbody>
                {% for detalle in detalles_list %}
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px;"><strong>{{ detalle.folio }}</strong></td>
                    <td style="padding: 12px;">{{ detalle.cliente|truncatewords:5 }}</td>
                    <td style="padding: 12px; text-align: right;">${{ detalle.total|floatformat:2 }}</td>
                    <td style="padding: 12px; text-align: right;">${{ detalle.suma|floatformat:2 }}</td>
                    <td style="padding: 12px; text-align: right; {% if detalle.diferencia > 0 %}color: #28a745;{% else %}color: #dc3545;{% endif %} font-weight: bold;">
                        {% if detalle.diferencia > 0 %}+{% endif %}${{ detalle.diferencia|floatformat:2 }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="background: #d4edda; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; margin: 20px 0;">
        <p style="margin: 0; color: #155724; font-weight: bold;">‚úÖ No hay diferencias significativas en este per√≠odo</p>
    </div>
    {% endif %}
    
    <!-- Registro Contable -->
    {% if facturas_con_diferencia > 0 %}
    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
        <h3 style="margin: 0 0 15px 0; color: #856404;">üìù Registro Contable Sugerido</h3>
        {% if total_diferencias > 0 %}
        <table style="width: 100%; font-family: monospace;">
            <tr>
                <td style="padding: 5px;"><strong>Cargo:</strong></td>
                <td style="padding: 5px;">Caja/Bancos</td>
                <td style="padding: 5px; text-align: right;">${{ total_diferencias|floatformat:2 }}</td>
            </tr>
            <tr>
                <td style="padding: 5px;"><strong>Abono:</strong></td>
                <td style="padding: 5px;">Otros Ingresos - Redondeo</td>
                <td style="padding: 5px; text-align: right;">${{ total_diferencias|floatformat:2 }}</td>
            </tr>
        </table>
        <p style="margin: 10px 0 0 0; color: #856404; font-size: 0.9em;">
            <em>(Diferencias por redondeo fiscal)</em>
        </p>
        {% else %}
        <table style="width: 100%; font-family: monospace;">
            <tr>
                <td style="padding: 5px;"><strong>Cargo:</strong></td>
                <td style="padding: 5px;">Gastos - Ajuste Redondeo</td>
                <td style="padding: 5px; text-align: right;">${{ total_diferencias|multiply:"-1"|floatformat:2 }}</td>
            </tr>
            <tr>
                <td style="padding: 5px;"><strong>Abono:</strong></td>
                <td style="padding: 5px;">Caja/Bancos</td>
                <td style="padding: 5px; text-align: right;">${{ total_diferencias|multiply:"-1"|floatformat:2 }}</td>
            </tr>
        </table>
        <p style="margin: 10px 0 0 0; color: #856404; font-size: 0.9em;">
            <em>(Diferencias por redondeo fiscal)</em>
        </p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Bot√≥n de regreso -->
    <div style="margin: 30px 0;">
        <a href="{% url 'admin:ventas_factura_changelist' %}" style="padding: 10px 20px; background: #417690; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
            ‚Üê Volver a Facturas
        </a>
    </div>
</div>
{% endblock %}
