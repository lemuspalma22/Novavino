{% extends "base.html" %}
{% block content %}
<h2>
  {% if modo == "flujo" %}
    Corte por Fecha de Pago (Flujo)
  {% else %}
    Corte por Fecha de Facturaci√≥n (Contable)
  {% endif %}
</h2>

<div style="margin-bottom: 20px;">
  <strong>Per√≠odo:</strong> {{ fi|date:"d-b-Y" }} a {{ ff|date:"d-b-Y" }}
</div>

<form method="get" style="margin-bottom: 20px;">
  <label>Modo:</label>
  <select name="modo">
    <option value="contable" {% if modo == "contable" %}selected{% endif %}>Contable (por fecha de factura)</option>
    <option value="flujo" {% if modo == "flujo" %}selected{% endif %}>Flujo (por fecha de pago)</option>
  </select>
  
  <label>Fecha Inicio:</label>
  <input type="date" name="fecha_inicio" value="{{ fi|date:'Y-m-d' }}" required>
  
  <label>Fecha Fin:</label>
  <input type="date" name="fecha_fin" value="{{ ff|date:'Y-m-d' }}" required>
  
  <button type="submit">Generar Reporte</button>
</form>

<div style="margin-bottom: 20px;">
  <form action="{% url 'exportar_csv' %}" method="get" style="display: inline;">
    <input type="hidden" name="fecha_inicio" value="{{ fi|date:'Y-m-d' }}">
    <input type="hidden" name="fecha_fin" value="{{ ff|date:'Y-m-d' }}">
    <input type="hidden" name="modo" value="{{ modo }}">
    <button type="submit">üì• Exportar a CSV</button>
  </form>
  
  <form action="{% url 'exportar_pdf' %}" method="get" style="display: inline; margin-left: 10px;">
    <input type="hidden" name="fecha_inicio" value="{{ fi|date:'Y-m-d' }}">
    <input type="hidden" name="fecha_fin" value="{{ ff|date:'Y-m-d' }}">
    <input type="hidden" name="modo" value="{{ modo }}">
    <button type="submit">üìÑ Exportar a PDF</button>
  </form>
</div>

<table border="1" cellpadding="8" cellspacing="0" style="width: 100%; border-collapse: collapse;" id="tabla-reporte">
  <thead>
    <tr style="background-color: #417690; color: white;">
      <th>
        <input type="checkbox" id="toggle-all" checked title="Seleccionar/Deseleccionar todo">
      </th>
      <th>Folio Factura</th>
      <th>Cliente</th>
      <th>Fecha</th>
      <th>Total Venta</th>
      <th>Costo Proveedores</th>
      <th>Transporte</th>
      <th>Ganancia Bruta</th>
      <th>% Ganancia</th>
      <th>Productos Personalizados</th>
      <th>Productos No Personalizados</th>
    </tr>
  </thead>
  <tbody>
    {% for item in reporte %}
    <tr class="factura-row" 
        data-total-venta="{{ item.total_venta }}"
        data-costo="{{ item.costo_proveedores }}"
        data-transporte="{{ item.transporte }}"
        data-ganancia="{{ item.ganancia }}">
      <td style="text-align: center;">
        <input type="checkbox" class="factura-checkbox" checked>
      </td>
      <td>{{ item.folio }}</td>
      <td>{{ item.cliente }}</td>
      <td>{{ item.fecha }}</td>
      <td style="text-align: right;">{{ item.total_venta|floatformat:2 }}</td>
      <td style="text-align: right;">{{ item.costo_proveedores|floatformat:2 }}</td>
      <td style="text-align: right;">{{ item.transporte|floatformat:2 }}</td>
      <td style="text-align: right;">{{ item.ganancia|floatformat:2 }}</td>
      <td style="text-align: right;">{{ item.porcentaje_ganancia|floatformat:2 }}%</td>
      <td>
        {% if item.productos_personalizados != "Ninguno" %}
          {% for nombre, cantidad in item.productos_personalizados.items %}
            <strong>{{ nombre }}:</strong> {{ cantidad }}<br>
          {% endfor %}
        {% else %}
          Ninguno
        {% endif %}
      </td>
      <td>
        {% if item.productos_no_personalizados != "Ninguno" %}
          {% for nombre, cantidad in item.productos_no_personalizados.items %}
            <strong>{{ nombre }}:</strong> {{ cantidad }}<br>
          {% endfor %}
        {% else %}
          Ninguno
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="11" style="text-align: center; color: #999;">
        No hay facturas en este per√≠odo
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr style="background-color: #f5f5f5; font-weight: bold;">
      <th></th>
      <th colspan="3">TOTALES</th>
      <th style="text-align: right;" id="total-venta">{{ totales.total_venta|floatformat:2 }}</th>
      <th style="text-align: right;" id="total-costo">{{ totales.total_costo_proveedores|floatformat:2 }}</th>
      <th style="text-align: right;" id="total-transporte">{{ totales.total_transporte|floatformat:2 }}</th>
      <th style="text-align: right;" id="total-ganancia">{{ totales.total_ganancia|floatformat:2 }}</th>
      <th style="text-align: right;" id="total-porcentaje">{{ totales.porcentaje_ganancia|floatformat:2 }}%</th>
      <th colspan="2"></th>
    </tr>
  </tfoot>
</table>

<div style="margin-top: 30px;">
  <a href="{% url 'admin:index' %}" class="button">‚Üê Volver al Admin</a>
</div>

<script>
// Recalcular totales bas√°ndose en checkboxes activos
function recalcularTotales() {
  let totalVenta = 0;
  let totalCosto = 0;
  let totalTransporte = 0;
  let totalGanancia = 0;

  // Iterar sobre todas las filas
  document.querySelectorAll('.factura-row').forEach(row => {
    const checkbox = row.querySelector('.factura-checkbox');
    
    if (checkbox && checkbox.checked) {
      // Sumar valores de esta fila
      totalVenta += parseFloat(row.dataset.totalVenta) || 0;
      totalCosto += parseFloat(row.dataset.costo) || 0;
      totalTransporte += parseFloat(row.dataset.transporte) || 0;
      totalGanancia += parseFloat(row.dataset.ganancia) || 0;
    }
  });

  // Calcular porcentaje de ganancia
  const porcentajeGanancia = totalVenta > 0 ? (totalGanancia / totalVenta) * 100 : 0;

  // Actualizar totales en la tabla
  document.getElementById('total-venta').textContent = totalVenta.toFixed(2);
  document.getElementById('total-costo').textContent = totalCosto.toFixed(2);
  document.getElementById('total-transporte').textContent = totalTransporte.toFixed(2);
  document.getElementById('total-ganancia').textContent = totalGanancia.toFixed(2);
  document.getElementById('total-porcentaje').textContent = porcentajeGanancia.toFixed(2) + '%';
}

// Toggle todas las facturas
document.getElementById('toggle-all').addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.factura-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = this.checked;
  });
  recalcularTotales();
});

// Escuchar cambios en checkboxes individuales
document.querySelectorAll('.factura-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    // Actualizar estado del toggle-all
    const allCheckboxes = document.querySelectorAll('.factura-checkbox');
    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
    document.getElementById('toggle-all').checked = allChecked;
    
    recalcularTotales();
  });
});
</script>

{% endblock %}
